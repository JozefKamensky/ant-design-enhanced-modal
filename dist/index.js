"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var React=require("react"),reactUid=require("react-uid"),antd=require("antd"),__assign=function(){return(__assign=Object.assign||function(e){for(var n,t=1,i=arguments.length;t<i;t++)for(var a in n=arguments[t])Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a]);return e}).apply(this,arguments)};function __rest(e,n){var t={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&n.indexOf(i)<0&&(t[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(i=Object.getOwnPropertySymbols(e);a<i.length;a++)n.indexOf(i[a])<0&&Object.prototype.propertyIsEnumerable.call(e,i[a])&&(t[i[a]]=e[i[a]])}return t}function __spreadArrays(){for(var e=0,n=0,t=arguments.length;n<t;n++)e+=arguments[n].length;var i=Array(e),a=0;for(n=0;n<t;n++)for(var s=arguments[n],o=0,r=s.length;o<r;o++,a++)i[a]=s[o];return i}var DraggableModalContext=React.createContext(null),ResizeHandle=function(e){return React.createElement("div",__assign({className:"ant-design-draggable-modal-resize-handle"},e),React.createElement("div",{className:"ant-design-draggable-modal-resize-handle-inner"}))},useDrag=function(e,n,t){var i=React.useState(!1),a=i[0],s=i[1],o=React.useState({initX:0,initY:0,mouseDownX:0,mouseDownY:0}),r=o[0],d=o[1],c=React.useCallback(function(t){t.clientX&&t.preventDefault();var i=t.clientX?t.clientX:t.changedTouches[0].clientX,a=t.clientY?t.clientY:t.changedTouches[0].clientY;d({initX:e,initY:n,mouseDownX:i,mouseDownY:a}),s(!0)},[e,n,s,d]);return React.useEffect(function(){var e=function(e){if(a){var n=r.initX,i=r.mouseDownX,s=r.initY,o=r.mouseDownY,d=e.clientX?e.clientX:e.changedTouches[0].clientX,c=e.clientY?e.clientY:e.changedTouches[0].clientY;t({x:n+(d-i),y:s+(c-o)})}};return window.addEventListener("mousemove",e,{passive:!0}),window.addEventListener("touchmove",e,{passive:!0}),function(){window.removeEventListener("mousemove",e),window.removeEventListener("touchmove",e)}},[r,a,t]),React.useEffect(function(){var e=function(){s(!1)};return window.addEventListener("mouseup",e),window.addEventListener("touchend",e),function(){window.removeEventListener("mouseup",e),window.removeEventListener("touchend",e)}},[s]),c},usePrevious=function(e){var n=React.useRef(null);return React.useEffect(function(){n.current=e}),n.current},useResize=function(e,n,t,i,a){var s=React.useState(!1),o=s[0],r=s[1],d=React.useState({initX:0,initY:0,initWidth:0,initHeight:0,mouseDownX:0,mouseDownY:0}),c=d[0],l=d[1],u=React.useCallback(function(a){a.clientX&&a.preventDefault();var s=a.clientX?a.clientX:a.changedTouches[0].clientX,o=a.clientY?a.clientY:a.changedTouches[0].clientY;l({initX:e,initY:n,initWidth:t,initHeight:i,mouseDownX:s,mouseDownY:o}),r(!0)},[t,i,r,l,e,n]);return React.useEffect(function(){var e=function(e){if(o){var n=c.initX,t=c.initY,i=c.initWidth,s=c.mouseDownX,r=c.initHeight,d=c.mouseDownY,l=e.clientX?e.clientX:e.changedTouches[0].clientX,u=e.clientY?e.clientY:e.changedTouches[0].clientY;return a({x:n,y:t,width:i+(l-s),height:r+(u-d)})}};return window.addEventListener("mousemove",e,{passive:!0}),window.addEventListener("touchmove",e,{passive:!0}),function(){window.removeEventListener("mousemove",e),window.removeEventListener("touchmove",e)}},[c,o,a]),React.useEffect(function(){var e=function(){r(!1)};return window.addEventListener("mouseup",e),window.addEventListener("touchend",e),function(){window.removeEventListener("mouseup",e),window.removeEventListener("touchend",e)}},[r]),u},modalStyle={margin:0,paddingBottom:0,pointerEvents:"auto"},DraggableModalInner=React.memo(function(e){var n=e.id,t=e.modalState,i=e.dispatch,a=e.visible,s=e.children,o=e.title,r=__rest(e,["id","modalState","dispatch","visible","children","title"]);React.useEffect(function(){return i({type:"mount",id:n}),function(){return i({type:"unmount",id:n})}},[i,n]);var d=usePrevious(a);React.useEffect(function(){a!==d&&i(a?{type:"show",id:n}:{type:"hide",id:n})},[a,d,n,i]);var c=t.zIndex,l=t.x,u=t.y,g=t.width,w=t.height,m=React.useMemo(function(){return __assign(__assign({},modalStyle),{top:u,left:l,height:w})},[u,l,w]),h=React.useCallback(function(){return i({type:"focus",id:n})},[n,i]),_=React.useCallback(function(e){return i(__assign({type:"drag",id:n},e))},[i,n]),v=React.useCallback(function(e){return i(__assign({type:"resize",id:n},e))},[i,n]),f=useDrag(l,u,_),x=useResize(l,u,g,w,v),p=React.useMemo(function(){return React.createElement("div",{className:"ant-design-draggable-modal-title",onTouchStart:f,onMouseDown:f,onClick:h},o)},[f,h,o]);return React.createElement(antd.Modal,__assign({wrapClassName:"ant-design-draggable-modal",style:m,width:g,destroyOnClose:!0,mask:!1,maskClosable:!1,zIndex:c,title:p,visible:a},r),s,React.createElement(ResizeHandle,{onTouchStart:x,onMouseDown:x}))});DraggableModalInner.displayName="DraggableModalInner";var getWindowSize=function(){return{width:window.innerWidth||0,height:window.innerHeight||0}},clamp=function(e,n,t){return Math.max(e,Math.min(n,t))},mapObject=function(e,n){return Object.assign.apply(Object,__spreadArrays([{}],Object.keys(e).map(function(t){var i;return(i={})[t]=n(e[t]),i})))},initialModalsState={maxZIndex:0,windowSize:getWindowSize(),modals:{}},initialModalState={x:0,y:0,width:800,height:800,zIndex:0,visible:!1},getModalState=function(e,n){return e.modals[n]||initialModalState},getNextZIndex=function(e,n){return getModalState(e,n).zIndex===e.maxZIndex?e.maxZIndex:e.maxZIndex+1},clampDrag=function(e,n,t,i,a,s){var o=n-s;return{x:clamp(0,e-a,t),y:clamp(0,o,i)}},clampResize=function(e,n,t,i,a,s){var o=n-i;return{width:clamp(200,e-t,a),height:clamp(200,o,s)}},draggableModalReducer=function(e,n){var t,i,a,s,o,r;switch(n.type){case"resize":var d=clampResize(e.windowSize.width,e.windowSize.height,n.x,n.y,n.width,n.height);return __assign(__assign({},e),{maxZIndex:getNextZIndex(e,n.id),modals:__assign(__assign({},e.modals),(t={},t[n.id]=__assign(__assign(__assign({},e.modals[n.id]),d),{zIndex:getNextZIndex(e,n.id)}),t))});case"drag":return __assign(__assign({},e),{maxZIndex:getNextZIndex(e,n.id),modals:__assign(__assign({},e.modals),(i={},i[n.id]=__assign(__assign(__assign({},e.modals[n.id]),clampDrag(e.windowSize.width,e.windowSize.height,n.x,n.y,e.modals[n.id].width,e.modals[n.id].height)),{zIndex:getNextZIndex(e,n.id)}),i))});case"show":var c=e.modals[n.id],l=e.windowSize.width/2-c.width/2,u=e.windowSize.height/2-c.height/2,g=clampDrag(e.windowSize.width,e.windowSize.height,l,u,c.width,c.height),w=clampResize(e.windowSize.width,e.windowSize.height,g.x,g.y,c.width,c.height);return __assign(__assign({},e),{maxZIndex:e.maxZIndex+1,modals:__assign(__assign({},e.modals),(a={},a[n.id]=__assign(__assign(__assign(__assign({},c),g),w),{zIndex:e.maxZIndex+1,visible:!0}),a))});case"focus":var m=e.modals[n.id];return __assign(__assign({},e),{maxZIndex:e.maxZIndex+1,modals:__assign(__assign({},e.modals),(s={},s[n.id]=__assign(__assign({},m),{zIndex:e.maxZIndex+1}),s))});case"hide":var h=e.modals[n.id];return __assign(__assign({},e),{modals:__assign(__assign({},e.modals),(o={},o[n.id]=__assign(__assign({},h),{visible:!1}),o))});case"mount":return __assign(__assign({},e),{maxZIndex:e.maxZIndex+1,modals:__assign(__assign({},e.modals),(r={},r[n.id]=__assign(__assign({},initialModalState),{x:e.windowSize.width/2-initialModalState.width/2,y:e.windowSize.height/2-initialModalState.height/2,zIndex:e.maxZIndex+1}),r))});case"unmount":var _=__assign({},e.modals);return delete _[n.id],__assign(__assign({},e),{modals:_});case"windowResize":return __assign(__assign({},e),{windowSize:n.size,modals:mapObject(e.modals,function(n){if(!n.visible)return n;var t=clampDrag(e.windowSize.width,e.windowSize.height,n.x,n.y,n.width,n.height),i=clampResize(e.windowSize.width,e.windowSize.height,t.x,t.y,n.width,n.height);return __assign(__assign(__assign({},n),t),i)})});default:throw new Error}},DraggableModal=function(e){var n=reactUid.useUID(),t=React.useContext(DraggableModalContext);if(!t)throw new Error("No Provider");var i=t.dispatch,a=t.state,s=getModalState(a,n);return React.createElement(DraggableModalInner,__assign({id:n,dispatch:i,modalState:s},e))},DraggableModalProvider=function(e){var n=e.children,t=React.useReducer(draggableModalReducer,initialModalsState),i=t[0],a=t[1];return React.useEffect(function(){if("object"==typeof window){var e=function(){return a({type:"windowResize",size:getWindowSize()})};return window.addEventListener("resize",e),e(),function(){return window.removeEventListener("resize",e)}}},[a]),React.createElement(DraggableModalContext.Provider,{value:{state:i,dispatch:a}},n)};exports.DraggableModal=DraggableModal,exports.DraggableModalContext=DraggableModalContext,exports.DraggableModalProvider=DraggableModalProvider;
//# sourceMappingURL=index.js.map
